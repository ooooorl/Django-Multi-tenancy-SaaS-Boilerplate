name: Build Artifact

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Choose environment to build for"
        required: true
        type: choice
        default: staging
        options:
          - staging
          - prod

jobs:
  docker-build:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.env }}

    env:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      IMAGE_NAME: multi-tenancy-backend
      IMAGE_SHA: ${{ github.sha }}
      ENV_NAME: ${{ github.event.inputs.env }}

    steps:
      - name: Validate branch and environment
        run: |
          echo "Selected environment: $ENV_NAME"
          echo "Branch: ${{ github.ref_name }}"

          if [[ "$ENV_NAME" == "staging" && "${{ github.ref_name }}" != "staging" ]]; then
            echo "ERROR: Staging builds must run from staging branch!"
            exit 1
          fi

          if [[ "$ENV_NAME" == "prod" && "${{ github.ref_name }}" != "master" ]]; then
            echo "ERROR: Prod builds must run from master branch!"
            exit 1
          fi

          echo "âœ“ Branch and environment match."

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate final Docker tag
        id: final_tag
        run: |
          if [[ "$ENV_NAME" == "prod" ]]; then
            # Prod: use semantic version from github-tag-action
            echo "Using prod SEMVER"
            TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          else
            # Staging: append short SHA
            TAG="v0.0.0-staging-${IMAGE_SHA::7}"
          fi

          # Docker-safe: lowercase, no invalid chars
          TAG=$(echo "$TAG" | tr '[:upper:]' '[:lower:]')
          echo "final_tag=$TAG" >> $GITHUB_OUTPUT
          echo "Docker tag will be: $TAG"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          DOCKER_TAG=${{ steps.final_tag.outputs.final_tag }}
          docker build \
            -t $DOCKER_HUB_USERNAME/$IMAGE_NAME:$IMAGE_SHA \
            -t $DOCKER_HUB_USERNAME/$IMAGE_NAME:$ENV_NAME \
            -t $DOCKER_HUB_USERNAME/$IMAGE_NAME:$DOCKER_TAG \
            .

      - name: Export Docker image
        run: |
          DOCKER_TAG=${{ steps.final_tag.outputs.final_tag }}
          docker save $DOCKER_HUB_USERNAME/$IMAGE_NAME:$DOCKER_TAG \
            -o multi-tenancy-backend-$DOCKER_TAG.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: multi-tenancy-backend-image
          path: multi-tenancy-backend-${{ steps.final_tag.outputs.final_tag }}.tar

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Push Docker images
        run: |
          DOCKER_TAG=${{ steps.final_tag.outputs.final_tag }}
          docker push $DOCKER_HUB_USERNAME/$IMAGE_NAME:$IMAGE_SHA
          docker push $DOCKER_HUB_USERNAME/$IMAGE_NAME:$ENV_NAME
          docker push $DOCKER_HUB_USERNAME/$IMAGE_NAME:$DOCKER_TAG
